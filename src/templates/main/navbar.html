{% load i18n %}

{% url 'home-view' as path_to_home %}
{% url 'articles:news-papers' as path_to_news_papers %}
{% url 'profiles:my-profile-view' as path_to_my_profile %}
{% url 'questions:experiment_end' as experiment_end %}
{% url 'questions:questions_after' as questions_after %}

<div class="ui secondary menu nav">
  {% if not request.user.is_authenticated %}
  <div class="ui container">
    <a href="{{ path_to_home }}" class="{% if request.path == path_to_home %}active{% endif %} item">
       <i class="fab fa-facebook"></i> 
    </a>
  </div> 
  <a href="{% url 'account_login' %}" class="ui item">
        Login
  </a>
  {% else %}
  
  <div class="ui top fixed menu">
    <div class="ui container">
      <!-- Zurück-Button -->
      <div class="item">
        <button class="ui icon button" onclick="goBackAndReload()" aria-label="Go Back">
          <i class="arrow left icon"></i> Zurück
        </button>
      </div>

      {% comment %} <!-- Vor-Button -->
      <div class="item">
        <button class="ui icon button" onclick="goForwardAndReload()" aria-label="Go Forward">
          <i class="arrow right icon"></i> Vor
        </button>
      </div> {% endcomment %}


      <!-- Home-Button -->
      <a href="{{ path_to_news_papers }}" class="item {% if request.path == path_to_news_papers %}active{% endif %}">
        <i class="home icon"></i> Home
      </a>

      <!-- Rechte Seite der Navigation -->
      <div class="right menu">
        <!-- Timer -->
        {% if request.session.newspaper_entry_time %}
        <div class="item" id="timer">
          <i class="clock outline icon"></i>
          <span>Remaining Time: <span id="timer-countdown">Calculating...</span></span>
        </div>
        {% endif %}

        <!-- Profil-Link -->
        <a href="{{ path_to_my_profile }}" class="item {% if request.path == path_to_my_profile %}active{% endif %}">
          <img src="{{ picture.url }}" class="ui avatar image" alt="Profilbild">&nbsp; {{ request.user }}
        </a>

        <!-- After Questions -->
        <a href="{{ questions_after }}" class="item">
          <i class="question circle outline icon"></i>&nbsp; Complete and Submit
        </a>

        <!-- Cancel Experiment -->
        <a href="{% url 'account_logout' %}" class="item">
          <i class="sign-out alternate icon"></i>&nbsp; Cancel (Quit Experiment)
        </a>
      </div>
    </div>
  </div>

  {% endif %}
</div>
<br>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const timerElement = document.getElementById('timer-countdown');
    const loginTimeRaw = "{{ request.session.newspaper_entry_time|default:''|escapejs }}";
    const maxDuration = {{ MAX_SESSION_DURATION|default:3600 }};  // Maximale Sitzungszeit
    const loginTime = new Date(loginTimeRaw);

    if (!loginTimeRaw || isNaN(loginTime.getTime())) {
      console.error("Timer inactive: No valid entry time found. Raw value:", loginTimeRaw);
      return;
    }

    const endTime = loginTime.getTime() + (maxDuration * 1000);

    function updateTimer() {
      const now = new Date().getTime();
      const remaining = endTime - now;

      if (remaining > 0) {
        const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
        timerElement.textContent = `${minutes}m ${seconds}s`;
      } else {
        timerElement.textContent = "Time's up!";
        if (!window.location.href.includes("/questions/after/")) {
          window.location.href = "/questions/after/?redirected_from_timer=true";
          
        }
      }
    }

    setInterval(updateTimer, 1000);
    updateTimer();
  });
  {% comment %} Auskommentiert weil der Button nicht so läuft wie er soll: Still TODO {% endcomment %}
{% comment %} function goForwardAndReload() {
    let historyStack = JSON.parse(sessionStorage.getItem('historyStack')) || [];
    let currentIndex = historyStack.indexOf(window.location.href);

    if (currentIndex < historyStack.length - 1) {
        let nextUrl = historyStack[currentIndex + 1];
        history.pushState(null, null, nextUrl); // Update browser history
        location.reload(); // Reload to reflect the new URL
    } else {
        console.warn("No forward page available.");
    }
} {% endcomment %}

function goBackAndReload() {
    let historyStack = JSON.parse(sessionStorage.getItem('historyStack')) || [];
    let currentIndex = historyStack.indexOf(window.location.href);

    if (currentIndex > 0) {
        let previousUrl = historyStack[currentIndex - 1];
        history.pushState(null, null, previousUrl); // Update browser history
        location.reload(); // Reload to reflect the new URL
    } else {
        console.warn("No previous page available.");
    }
}

// Track history using pushState to keep browser history and sessionStorage in sync
(function trackHistory() {
    let historyStack = JSON.parse(sessionStorage.getItem('historyStack')) || [];
    let currentUrl = window.location.href;

    // Add the current URL if it's not the last entry
    if (historyStack[historyStack.length - 1] !== currentUrl) {
        historyStack.push(currentUrl);
        sessionStorage.setItem('historyStack', JSON.stringify(historyStack));
    }

    // Ensure initial pushState to avoid duplicate entries
    if (history.state === null) {
        history.replaceState({ index: historyStack.length - 1 }, '');
    }

    // Listen for popstate events (back/forward navigation)
    window.addEventListener('popstate', function(e) {
        // Reload the page to ensure content matches the URL
        location.reload();
    });
})();


</script>
